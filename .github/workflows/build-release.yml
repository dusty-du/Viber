name: Build Release App Bundle

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Xcode version
        run: xcodebuild -version

      - name: Build app bundle
        run: ./create-app-bundle.sh

      - name: Zip app bundle
        run: |
          ditto -c -k --sequesterRsrc --keepParent VibeProxy.app VibeProxy.app.zip

      - name: Checkout main for appcast update
        run: |
          git fetch origin main
          git checkout main

      - name: Generate signed appcast entry
        env:
          SPARKLE_ED25519_PRIVATE_KEY: ${{ secrets.SPARKLE_ED25519_PRIVATE_KEY }}
          RELEASE_TAG: ${{ github.ref_name }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          set -euo pipefail
          if [ -z "${SPARKLE_ED25519_PRIVATE_KEY:-}" ]; then
            echo "Missing SPARKLE_ED25519_PRIVATE_KEY secret"
            exit 1
          fi

          KEY_FILE="$(mktemp)"
          printf "%s" "$SPARKLE_ED25519_PRIVATE_KEY" > "$KEY_FILE"

          curl -L -o sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.5.0/Sparkle-2.5.0.tar.xz
          tar -xf sparkle.tar.xz

          GEN_TOOL=""
          if [ -x "./bin/generate_appcast" ]; then
            GEN_TOOL="./bin/generate_appcast"
          else
            GEN_TOOL="$(find . -maxdepth 4 -type f -path "*/bin/generate_appcast" | head -1)"
          fi
          if [ -z "$GEN_TOOL" ]; then
            echo "generate_appcast not found after extracting Sparkle"
            find . -maxdepth 4 -type f -name generate_appcast
            exit 1
          fi

          mkdir -p sparkle_updates
          cp VibeProxy.app.zip sparkle_updates/

          "$GEN_TOOL" \
            --ed-key-file "$KEY_FILE" \
            --download-url-prefix "https://github.com/dusty-du/Viber/releases/download/${RELEASE_TAG}/" \
            --link "https://github.com/dusty-du/Viber" \
            -o appcast.xml \
            sparkle_updates

      - name: Commit appcast update
        run: |
          set -euo pipefail
          if git diff --quiet appcast.xml; then
            echo "No appcast changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast for ${{ github.ref_name }}"
          git push origin main

      - name: Upload to release (tag push)
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            VibeProxy.app.zip
          generate_release_notes: true

      - name: Upload to release (published release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: VibeProxy.app.zip
